<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ArcGIS Setup</title>
  <!-- Load Calcite Components -->
  <script type="module" src="https://js.arcgis.com/calcite-components/2.10.0/calcite.esm.js"></script>
  <link rel="stylesheet" href="https://js.arcgis.com/calcite-components/2.10.0/calcite.css" />
<style>
  /* Make the main container flexible */
main {
  display: flex;
  justify-content: center;
  padding: 2rem;
}

/* Make the card responsive */
calcite-card {
  max-width: 400px;   /* limits width on desktop */
  width: 100%;        /* full width on mobile */
}

/* Adjust font sizes on small screens */
@media (max-width: 480px) {
  h1 {
    font-size: 1.5rem;
  }

  calcite-input,
  calcite-button {
    font-size: 0.9rem;
  }

  form {
    padding: 1rem;
  }
}

/* Optional: stack elements with spacing for very small screens */
@media (max-width: 360px) {
  form calcite-label {
    margin-bottom: 0.75rem;
  }

  calcite-button {
    padding: 0.6rem;
  }
}

</style>

</head>
<body>
  <main style="display:flex; justify-content:center; padding:2rem;">
    <calcite-card style="max-width:400px; width:100%;">
      <h1 style="text-align:center; margin-bottom:1rem;">ArcGIS Onboarding</h1>

        <calcite-button id="btn-signin" width="full" scale="l" style="margin-top:1rem;">
          Sign in
        </calcite-button>

        <calcite-button id="btn-signup" appearance="outline" width="full" scale="l" style="margin-top:1rem;">
          Sign up
        </calcite-button>
      <calcite-notice id="message" width="full" open style="display:none; margin-top:1rem;">
        <div slot="message"></div>
      </calcite-notice>
    </calcite-card>
  </main>

<script type="module">

  const clientId = "uRLY3aOtK0x5dCCF";
  const redirectUri = "https://witty-tree-044dc8200.2.azurestaticapps.net/callback.html";

  const dec2hex = (dec) => {
    return ("0" + dec.toString(16)).substr(-2);
  };

  const generateRandomString = () => {
    const array = new Uint8Array(32); // 32 bytes = 256 bits
    window.crypto.getRandomValues(array);
    return Array.from(array, dec2hex).join("");
  };

  const challengeFromVerifier = async (verifier) => {
    const encoder = new TextEncoder();
    const data = encoder.encode(verifier);
    const sha256 = await window.crypto.subtle.digest("SHA-256", data);
    const bytes = new Uint8Array(sha256);
    let str = "";
    for (let i = 0; i < bytes.byteLength; i++) {
      str += String.fromCharCode(bytes[i]);
    }
    return btoa(str)
      .replace(/\+/g, "-")
      .replace(/\//g, "_")
      .replace(/=+$/, "");
  };

  // build everything once DOM is ready
  document.addEventListener("DOMContentLoaded", async () => {
    const codeVerifier = generateRandomString();
    localStorage.setItem("pkce_verifier", codeVerifier); // save for later
    const codeChallenge = await challengeFromVerifier(codeVerifier);

    const authorizationEndpoint =
      "https://www.arcgis.com/sharing/rest/oauth2/authorize" +
      "?client_id=" + encodeURIComponent(clientId) +
      "&code_challenge=" + encodeURIComponent(codeChallenge) +
      "&code_challenge_method=S256" +
      "&redirect_uri=" + encodeURIComponent(redirectUri) +
      "&response_type=code" +
      "&expiration=20160";

    const signInButton = document.getElementById("btn-signin");
    signInButton.addEventListener("click", () => {
      window.location.href=authorizationEndpoint
    });

    const signUpButton = document.getElementById("btn-signup");

    const params = new URLSearchParams(window.location.search)
    const globalid = params.get("id")

    signUpButton.addEventListener("click", () => {
      window.location.href = "signup.html?id="+globalid
    })
    if (globalid === null || globalid.length !== 36){
      showMessage("Invalid app id in url", "danger")
      signInButton.disabled = true
      signUpButton.disabled = true
    }
    localStorage.setItem("globalid", globalid); // save for later

  });

    function showMessage(text, kind) {
      message.style.display = "block";
      message.kind = kind; // "success", "danger", "info", etc.
      message.querySelector("[slot=message]").innerText = text;
    }

</script>

</body>
</html>
